@page "/funcionario/{userId:guid}/detalhes"


@{
    Layout = "_Layout";
}


<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Funcionários</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://adminlte.io/themes/v3/dist/css/adminlte.min.css?v=3.2.0" />
</head>
<body>

    <div class="content-wrapper" style="margin-left:0">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1>Detalhe do funcionário</h1>
                    </div>
                    <div class="col-sm-6">
                        <ol class="breadcrumb float-sm-right">
                            <li class="breadcrumb-item"><a href="#">Home</a></li>
                            <li class="breadcrumb-item active">Detalhe do funcionário</li>
                        </ol>
                    </div>
                </div>
            </div><!-- /.container-fluid -->
        </section>


        <section class="content">


            <!-- Default box -->
            <div class="card">
                <div class="card-header">
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-tool" data-card-widget="remove" title="Remove">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 col-md-12 col-lg-8 order-2 order-md-1">
                            <div class="row">
                                <div class="col-12 col-sm-4">
                                    <div class="info-box bg-light">
                                        <div class="info-box-content" id="boxHoursWorked">

                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-4">
                                    <div class="info-box bg-light">
                                        <div class="info-box-content" id="boxDailyJourney">

                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 col-sm-4">
                                    <div class="info-box bg-light">
                                        <div class="info-box-content" id="boxWeeklyJourney">

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row" id="infoPunchClockRow">
                                <h4>Registros recentes:</h4>
                                
                            </div>
                        </div>
                        <div class="col-12 col-md-12 col-lg-4 order-1 order-md-2">
                            <h3 class="text-primary"><i class="fas fa-paint-brush"></i> Dados</h3>
                            <div class="text-muted">
                                <p class="text-sm">
                                    Nome do funcionário:
                                    <b class="d-block" id="dataUserName">Deveint Inc</b>
                                </p>
                                <p class="text-sm">
                                    Jornada de trabalho semanal:
                                    <b class="d-block" id="dataWeeklyJourney">Tony Chicken</b>
                                </p>
                                <p class="text-sm">
                                    Tipo de usuário:
                                    <b class="d-block" id="dataRole">Employee</b>
                                </p>
                                <p class="text-sm">
                                    Cargo:
                                    <b class="d-block" id="dataPosition">Developtment</b>
                                </p>
                                <p class="text-sm">
                                    Setor:
                                    <b class="d-block" id="dataDepartment">IT</b>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.card-body -->
            </div>
            <!-- /.card -->

        </section>
    </div>

    <script>


                document.addEventListener("DOMContentLoaded", function() {
            // Função para obter o token JWT do localStorage
            const token = localStorage.getItem('jwt');

            const path = window.location.pathname;
            const pathParts = path.split('/');
            const userId = pathParts[2];  // O valor será '1234'
            console.log(userId);

            // Se o token não estiver presente, redirecione ou exiba uma mensagem de erro
            if (!token) {
                console.log('Usuário não autenticado. Redirecionando para o login...');
                window.location.href = '/login';  // Redirecionar para a página de login (ou outro comportamento)
                return;
            }

            // Fazer uma requisição GET para a API de Funcionários
            fetch('/api/User/v1/user/infos', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                    'userId': userId // Incluir o userId no cabeçalho
                }
            })
            .then(response => {
                if (!response.ok) {
                    // Se a resposta não for ok (erro), você pode lidar com isso de acordo
                    return response.json().then(errorData => {
                        console.error('Erro:', errorData);
                        alert('Erro ao carregar os funcionários.');
                    });
                }
                return response.json(); // Caso a resposta seja bem-sucedida, converta para JSON
            })
            .then(data => {
                const boxHoursWorked = document.getElementById('boxHoursWorked');
                const boxDailyJourney = document.getElementById('boxDailyJourney');
                const boxWeeklyJourney = document.getElementById('boxWeeklyJourney');
                const container = document.getElementById('infoPunchClockRow');

                // Limpar o conteúdo anterior, se necessário
                boxHoursWorked.innerHTML = '';
                boxDailyJourney.innerHTML = '';
                boxWeeklyJourney.innerHTML = '';
                


               
                // Iterar sobre os funcionários e adicionar cada um ao corpo da tabela
                boxHoursWorked.innerHTML += `
                    <span class="info-box-text text-center text-muted">Horas trabalhadas</span>
                    <span class="info-box-number text-center text-muted mb-0" id="hoursWorked">${data.hoursWorked}h</span>
                    `;

                boxDailyJourney.innerHTML += `
                    <span class="info-box-text text-center text-muted">Jornada diária</span>
                    <span class="info-box-number text-center text-muted mb-0">${data.settings.workdayHours}h</span>
                    `;

                boxWeeklyJourney.innerHTML += `
                    <span class="info-box-text text-center text-muted">Jornada Semanal</span>
                    <span class="info-box-number text-center text-muted mb-0">${data.settings.weeklyJourney}h</span>
                `;


                data.registers.forEach(register => {
                                    
                    const checkIn = register.checkIns.length > 0 ? register.checkIns[0] : null;
                    const checkOut = register.checkOuts.length > 0 ? register.checkOuts[0] : null; // Verifique se há checkout

                    // Formatar data de check-in
                    const checkInDate = checkIn ? new Date(checkIn.timestamp) : null;
                    const checkOutDate = checkOut ? new Date(checkOut.timestamp) : null;

                    const formatDate = (date) => {
                    if (date) {
                        const options = { weekday: 'long', year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
                        return new Intl.DateTimeFormat('pt-BR', options).format(date);
                    }
                      return '';
                    };

                    if(checkIn != null && checkOut == null){
                         const htmlContent = `
                            <div class="col-12">                               
                                <div class="card">
                                    <div class="card-body">
                                        <div class="post">
                                            <div class="user-block">
                                                <span class="username" id="nameUserPunchClock" style="margin-left: 0;">
                                                    ${data.name}
                                                </span>
                                                <span class="description" id="datePunchClock" style="margin-left: 0;">
                                                    ${register.checkIns[0].message} - ${checkInDate}
                                                </span>
                                            </div>
                                        <p id="messagePunchClock">

                                        </p>
                                    </div>
                                </div>
                               </div>
                         `;

                     container.innerHTML += htmlContent;
                    }else if(checkIn != null && checkOut != null){
                        const htmlContent = `
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="post">
                                            <div class="user-block">
                                                <span class="username" id="nameUserPunchClock" style="margin-left: 0;">
                                                    ${data.name}
                                                </span>
                                                <span class="description" id="datePunchClock" style="margin-left: 0;">
                                                    ${register.checkIns[0].message} - ${checkInDate}
                                                </span>
                                            </div>
                                        <p id="messagePunchClock">

                                        </p>
                                    </div>
                                </div>
                               </div>
                         `;
                         container.innerHTML += htmlContent;

                         const newHtmlContent = `
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <div class="post">
                                            <div class="user-block">
                                                <span class="username" id="nameUserPunchClock" style="margin-left: 0;">
                                                    ${data.name}
                                                </span>
                                                <span class="description" id="datePunchClock" style="margin-left: 0;">
                                                    ${register.checkOuts[0].message} - ${checkOutDate}
                                                </span>
                                            </div>
                                        <p id="messagePunchClock">

                                        </p>
                                    </div>
                                </div>
                               </div>
                         `;
                         container.innerHTML += newHtmlContent;
                    }
                
                });


                document.getElementById('dataUserName').textContent = data.name;
                document.getElementById('dataWeeklyJourney').textContent = data.hoursWorked;
                document.getElementById('dataRole').textContent = data.role;
                document.getElementById('dataDepartment').textContent = data.department;
                document.getElementById('dataPosition').textContent = data.position;

            })
            .catch(error => {
                console.error('Erro ao buscar os dados dos funcionários:', error);
            });
        });




    </script>


</body>
</html>

